<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<title>Falling Blocks</title>

<script src="mt19937class.js" ></script>
<script>

/*jslint browser: true, devel: true, passfail: true */
/*global MersenneTwister19937 */

function jsabort(msg) {
    "use strict";
    window.alert(msg);
    throw new Error('Aborting javascript: ' + msg);
}

function cx(stringparameter) {
    "use strict";
    console.log(stringparameter);
}

function ctstr(anyparameter) {
    "use strict";
    // a supposedly simple function to make a string from a var for debug
    //dumps, that has gotten way complicated over time...
    var x, rv, z, name, isArr;
    if (typeof anyparameter === 'object') {
        if (anyparameter === null) {
            return 'null';
        }
        name = '';
        isArr = false;
        if (anyparameter.constructor !== undefined) {
            name = anyparameter.constructor.toString();
        }
        if (name === 'function Object() { [native code] }') {
            name = '';
        }
        if (name === 'function Array() { [native code] }') {
            name = '';
            isArr = true;
        }
        if (name === 'function AudioContext() { [native code] }') {
            return 'object AudioContext';
        }
        if (name === '') {
            rv = '';
            for (z in anyparameter) {
                if (anyparameter.hasOwnProperty(z)) {
                    rv = rv + ', ' + z + ': ' + ctstr(anyparameter[z]);
                }
            }
            if (isArr) {
                return 'array [ ' + rv.substring(2) + ' ]';
            }
            return 'object { ' + rv.substring(2) + ' }';
        }
        return '{[Code Object]}';
    }
    if (typeof anyparameter === 'number') {
        return 'number ' + anyparameter.toString();
    }
    if (typeof anyparameter === 'string') {
        return 'string "' + anyparameter + '"';
    }
    if (typeof anyparameter === 'boolean') {
        return 'boolean ' + anyparameter.toString();
    }
    x = typeof anyparameter;
    window.alert(x);
    console.log('x', x);
    jsabort('typeof returned an undefined value');
}

function getRando(seedNum) {
    "use strict";
    var mt1, initAry, x;
    mt1 = new MersenneTwister19937();
    initAry = [0x123, 0x234, 0x345, 0x456];
    mt1.initByArray(initAry, 4);
    for (x = 0; x < (seedNum * 32); x = x + 1) {
        mt1.genrandInt32();
    }
    return mt1;
}

var gBlockSizePixelsX, gBlockSizePixelsY, gBlocksAcross, gBlocksDown, gRng, gBlackCol, gSaturateCol, gBlockCount, gBlockRelX, gBlockRelY, gBlockColor;

gBlockSizePixelsX = 40;
gBlockSizePixelsY = 40;

gBlocksAcross = 8;
gBlocksDown = 10;

gRng = getRando(0);

gBlackCol = 0;
gSaturateCol = 0;

gBlockCount = 0;
gBlockRelX = [];
gBlockRelY = [];
gBlockColor = [];


function drawBlock(x, y, color) {
    "use strict";
    var canvas, ctx;
    canvas = document.getElementById("gamebox");
    ctx = canvas.getContext("2d");
    ctx.fillStyle = color;
    ctx.fillRect(x * gBlockSizePixelsX, y * gBlockSizePixelsY, gBlockSizePixelsX, gBlockSizePixelsY);
}

function eraseBlock(x, y) {
    "use strict";
    drawBlock(x, y, "rgb(255, 255, 255)");
}

function generateColor(blackCol, saturateCol) {
    "use strict";
    var red, green, blue;
    if (blackCol === 0) {
        red = 0;
        if (saturateCol === 0) {
            green = 255;
            blue = Math.floor(gRng.genrandReal2() * 255);
        } else {
            blue = 255;
            green = Math.floor(gRng.genrandReal2() * 255);
        }
    } else {
        if (blackCol === 1) {
            green = 0;
            if (saturateCol === 0) {
                red = 255;
                blue = Math.floor(gRng.genrandReal2() * 255);
            } else {
                blue = 255;
                red = Math.floor(gRng.genrandReal2() * 255);
            }
        } else {
            blue = 0;
            if (saturateCol === 0) {
                red = 255;
                green = Math.floor(gRng.genrandReal2() * 255);
            } else {
                green = 255;
                red = Math.floor(gRng.genrandReal2() * 255);
            }
        }
    }
    return "rgb(" + red.toString(10) + ", " + green.toString(10) + ", " + blue.toString(10) + ")";
}

function scrambleBoard() {
    "use strict";
    var x, y;
    for (y = 0; y < gBlocksDown; y = y + 1) {
        for (x = 0; x < gBlocksAcross; x = x + 1) {
            drawBlock(x, y, generateColor(Math.floor(gRng.genrandReal2() * 3), Math.floor(gRng.genrandReal2() * 2)));
        }
    }
}

function createPiece(blocks) {
    "use strict";
    var i, x, y, dx, dy, r, pendx, pendy, notOk, notFound, j, stuckLoop, cmx, cmy;
    gBlockCount = blocks;
    gBlockRelX = [];
    gBlockRelY = [];
    gBlockColor = [];
    x = 0;
    y = 0;
    for (i = 0; i < blocks; i = i + 1) {
        gBlockRelX[i] = x;
        gBlockRelY[i] = y;
        gSaturateCol = gSaturateCol + 1;
        if (gSaturateCol === 3) {
            gSaturateCol = 1;
            gBlackCol = gBlackCol + 1;
            if (gBlackCol === 3) {
                gBlackCol = 0;
            }
        }
        gBlockColor[i] = generateColor(gBlackCol, gSaturateCol);
        notOk = true;
        stuckLoop = 0;
        while (notOk) {
            r = Math.floor(gRng.genrandReal2() * 4);
            if (r === 0) {
                dy = -1;
                dx = 0;
            } else {
                if (r === 1) {
                    dy = 0;
                    dx = 1;
                } else {
                    if (r === 2) {
                        dy = 1;
                        dx = 0;
                    } else {
                        if (r === 3) {
                            dy = 0;
                            dx = -1;
                        } else {
                            jsabort("point 45");
                        }
                    }
                }
            }
            if (i > 0) {
                j = Math.floor(gRng.genrandReal2() * (i + 1));
                x = gBlockRelX[j];
                y = gBlockRelY[j];
            }
            pendx = x + dx;
            pendy = y + dy;
            notFound = true;
            for (j = 0; j <= i; j = j + 1) {
                if ((gBlockRelX[j] === pendx) && (gBlockRelY[j] === pendy)) {
                    notFound = false;
                }
            }
            if (notFound) {
                notOk = false;
            }
            stuckLoop = stuckLoop + 1;
            if (stuckLoop === 100) {
                jsabort("point 6932");
                notOk = false;
                pendx = 0;
                pendy = 0;
                i = -1;
            }
        }
        x = pendx;
        y = pendy;
    }
    // centering process
    cmx = 0;
    cmy = 0;
    for (i = 0; i < blocks; i = i + 1) {
        cmx = cmx + gBlockRelX[i];
        cmy = cmy + gBlockRelY[i];
    }
    cmx = Math.floor(cmx / blocks);
    cmy = Math.floor(cmy / blocks);
    for (i = 0; i < blocks; i = i + 1) {
        gBlockRelX[i] = gBlockRelX[i] - cmx;
        gBlockRelY[i] = gBlockRelY[i] - cmy;
    }
}

</script>

</head>
<body style="font-size:40px;">
  <section>
    <h1>Falling Blocks</h1>
      <canvas id="gamebox" width="320" height="400" style="border: solid 1px black; width: 320px; height: 400px;"></canvas> 
  </section>

<script type="text/javascript">

var color;
color = "rgb(255, 0, 0)";

createPiece(4);
scrambleBoard();

</script>  

